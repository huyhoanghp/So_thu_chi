<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sổ Thu Chi Dùng Chung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal { transition: opacity 0.3s ease; }
        .spinner, .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        .loader { width: 48px; height: 48px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-button.active { 
            border-color: #4f46e5; 
            color: #4f46e5; 
            background-color: #eef2ff; 
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col justify-center items-center z-50">
        <div class="loader"></div>
        <p class="mt-4 text-gray-600 font-semibold">Đang kết nối sổ dùng chung...</p>
    </div>

    <div class="container mx-auto p-4 md:p-6 max-w-7xl pb-28">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Sổ Thu Chi Dùng Chung</h1>
            <p class="text-gray-600 mt-1">Dữ liệu được chia sẻ công khai cho mọi người dùng của sổ này.</p>
        </header>

        <main>
            <!-- BẢNG TỔNG QUAN -->
            <section id="summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-green-100 p-4 rounded-lg shadow-md text-center">
                    <h2 class="text-lg font-semibold text-green-800">Tổng Thu</h2>
                    <p id="total-income" class="text-2xl font-bold text-green-600">0 ₫</p>
                </div>
                <div class="bg-red-100 p-4 rounded-lg shadow-md text-center">
                    <h2 class="text-lg font-semibold text-red-800">Tổng Chi</h2>
                    <p id="total-expense" class="text-2xl font-bold text-red-600">0 ₫</p>
                </div>
                <div class="bg-indigo-100 p-4 rounded-lg shadow-md text-center">
                    <h2 class="text-lg font-semibold text-indigo-800">Lợi Nhuận</h2>
                    <p id="net-profit" class="text-2xl font-bold text-indigo-600">0 ₫</p>
                </div>
            </section>
            
            <div class="text-center mb-8 hidden md:block">
                <button id="add-transaction-btn-desktop" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300 text-lg disabled:bg-gray-400" disabled>
                    + Thêm Giao Dịch Mới
                </button>
            </div>
            
            <div class="bg-white p-4 md:p-6 rounded-lg shadow-md">
                <!-- CẢI TIẾN: Bộ lọc ngày tháng được đưa ra ngoài để áp dụng chung -->
                <div class="p-2 border-b border-gray-200 mb-4">
                  <div class="flex flex-col sm:flex-row flex-wrap gap-2 sm:gap-4 items-center justify-center">
                    <label class="font-semibold text-sm sm:text-base">Xem dữ liệu theo:</label>
                    <select id="report-range" class="border rounded-md px-2 py-1 w-full sm:w-auto">
                        <option value="all">Tất cả thời gian</option>
                        <option value="day">Hôm nay</option>
                        <option value="week">Tuần này</option>
                        <option value="month">Tháng này</option>
                        <option value="quarter">Quý này</option>
                        <option value="year">Năm nay</option>
                        <option value="custom">Tùy chọn...</option>
                    </select>
                    <div id="custom-date-range" class="hidden flex-col sm:flex-row gap-2 w-full sm:w-auto">
                        <input type="date" id="custom-start" class="border rounded-md px-2 py-1 w-full sm:w-auto">
                        <input type="date" id="custom-end" class="border rounded-md px-2 py-1 w-full sm:w-auto">
                    </div>
                  </div>
                </div>

                <!-- CẢI TIẾN: Bố cục tab nằm ngang ổn định -->
                <div class="border-b border-gray-200 mb-4">
                    <nav class="flex justify-around">
                        <button id="tab-history" class="w-full text-center tab-button text-sm sm:text-lg font-semibold px-2 py-3 sm:px-4 border-b-2 transition">Lịch Sử Giao Dịch</button>
                        <button id="tab-dashboard" class="w-full text-center tab-button text-sm sm:text-lg font-semibold px-2 py-3 sm:px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition">Báo Cáo & Biểu Đồ</button>
                    </nav>
                </div>

                <div>
                    <div id="content-history">
                        <div class="flex flex-col md:flex-row md:justify-between items-start md:items-center gap-4 mb-4">
                            <h2 class="text-xl font-bold w-full md:w-auto">Tất cả giao dịch</h2>
                            <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                                <button id="export-xlsx-btn" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300 text-sm disabled:bg-gray-400">Xuất Excel (.xlsx)</button>
                                <button id="analyze-expenses-btn" class="w-full sm:w-auto bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition duration-300 text-sm disabled:bg-gray-400">✨ Phân tích AI</button>
                            </div>
                        </div>
                        <div id="transaction-list-container" class="max-h-[500px] overflow-y-auto">
                            <ul id="transaction-list" class="space-y-3"></ul>
                        </div>
                        <p id="empty-state" class="text-center text-gray-500 py-8">Chưa có giao dịch nào. Hãy thêm giao dịch đầu tiên của bạn!</p>
                    </div>
                    <div id="content-dashboard" class="hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                            <div class="lg:col-span-2">
                                <h3 class="text-lg font-semibold text-center mb-2">Cơ Cấu Chi Phí</h3>
                                <canvas id="expense-pie-chart"></canvas>
                            </div>
                            <div class="lg:col-span-3">
                                 <h3 class="text-lg font-semibold text-center mb-2">Dòng Tiền Theo Thời Gian</h3>
                                <canvas id="flow-line-chart"></canvas>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- CẢI TIẾN: Tăng z-index để nút luôn nổi lên trên -->
    <div id="add-transaction-sticky-btn-container" class="md:hidden fixed bottom-0 left-0 right-0 p-4 bg-gray-100/80 backdrop-blur-sm border-t border-gray-200 z-40">
         <button id="add-transaction-btn-mobile" class="w-full bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300 text-lg disabled:bg-gray-400" disabled>
            + Thêm Giao Dịch Mới
        </button>
    </div>

    <!-- MODALs -->
    <div id="transaction-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 w-full max-w-lg transform transition-transform duration-300 scale-95 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">Thêm Giao Dịch Mới</h2>
            <form id="transaction-form">
                <div class="mb-4">
                    <label class="block font-semibold mb-2">Loại giao dịch</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center"><input type="radio" name="type" value="income" class="form-radio text-green-500" checked> <span class="ml-2">Khoản Thu</span></label>
                        <label class="flex items-center"><input type="radio" name="type" value="expense" class="form-radio text-red-500"> <span class="ml-2">Khoản Chi</span></label>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="description" class="block font-semibold mb-2">Nội dung</label>
                        <input type="text" id="description" placeholder="VD: Bán bún, Mua thịt..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                         <label for="amount" class="block font-semibold mb-2">Số tiền (VNĐ)</label>
                        <input type="number" id="amount" placeholder="Nhập số tiền" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="category" class="block font-semibold mb-2">Danh mục</label>
                        <select id="category" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required></select>
                    </div>
                     <div>
                        <label for="date" class="block font-semibold mb-2">Ngày</label>
                        <input type="date" id="date" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                </div>
                <div id="customer-info" class="space-y-4 mb-4 border-t pt-4">
                    <h3 class="font-semibold text-gray-600">Thông tin khách hàng (Không bắt buộc)</h3>
                    <div>
                        <label for="customerName" class="block font-semibold mb-2">Tên khách hàng</label>
                        <input type="text" id="customerName" placeholder="VD: Chị Lan" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="customerNote" class="block font-semibold mb-2">Ghi chú</label>
                        <textarea id="customerNote" rows="2" placeholder="VD: Giao hàng lúc 12h, không cay..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                </div>
                <div class="flex flex-col-reverse sm:flex-row sm:justify-end gap-3 mt-6">
                    <button type="button" id="cancel-btn" class="w-full sm:w-auto bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition">Hủy</button>
                    <button type="submit" class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Lưu</button>
                </div>
            </form>
        </div>
    </div>
    <div id="analysis-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
         <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 w-full max-w-2xl transform transition-transform duration-300 scale-95 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-bold text-purple-700">✨ Phân Tích Chi Tiêu Thông Minh</h2>
                <button id="close-analysis-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="analysis-content" class="overflow-y-auto">
                <div id="spinner-container" class="flex justify-center items-center py-16"><div class="spinner"></div></div>
                <div id="analysis-result" class="prose max-w-none text-gray-700"></div>
            </div>
        </div>
    </div>

    
<script>
// --- DOM Elements ---
const loadingOverlay = document.getElementById('loading-overlay');
const totalIncomeEl = document.getElementById('total-income');
const totalExpenseEl = document.getElementById('total-expense');
const netProfitEl = document.getElementById('net-profit');
const transactionList = document.getElementById('transaction-list');
const emptyState = document.getElementById('empty-state');
const addTransactionBtnDesktop = document.getElementById('add-transaction-btn-desktop');
const addTransactionBtnMobile = document.getElementById('add-transaction-btn-mobile');
const exportXlsxBtn = document.getElementById('export-xlsx-btn');
const transactionModal = document.getElementById('transaction-modal');
const cancelBtn = document.getElementById('cancel-btn');
const form = document.getElementById('transaction-form');
const descriptionInput = document.getElementById('description');
const amountInput = document.getElementById('amount');
const dateInput = document.getElementById('date');
const categorySelect = document.getElementById('category');
const customerInfoDiv = document.getElementById('customer-info');
const customerNameInput = document.getElementById('customerName');
const customerNoteInput = document.getElementById('customerNote');
const typeRadios = document.querySelectorAll('input[name="type"]');
const analyzeExpensesBtn = document.getElementById('analyze-expenses-btn');
const analysisModal = document.getElementById('analysis-modal');
const closeAnalysisBtn = document.getElementById('close-analysis-btn');
const spinnerContainer = document.getElementById('spinner-container');
const analysisResult = document.getElementById('analysis-result');
const tabHistory = document.getElementById('tab-history');
const tabDashboard = document.getElementById('tab-dashboard');
const contentHistory = document.getElementById('content-history');
const contentDashboard = document.getElementById('content-dashboard');
const reportRangeEl = document.getElementById('report-range');
const customDateRangeDiv = document.getElementById('custom-date-range');
const customStartEl = document.getElementById('custom-start');
const customEndEl = document.getElementById('custom-end');

let expensePieChart, flowLineChart;
const expensePieChartCtx = document.getElementById('expense-pie-chart')?.getContext('2d');
const flowLineChartCtx = document.getElementById('flow-line-chart')?.getContext('2d');

// --- Data ---
let transactions = [];
let transactionsCollection = null;
const categories = {
    income: ['Bán tại quán', 'Giao hàng', 'Thu khác'],
    expense: ['Nguyên liệu chính', 'Nguyên liệu phụ', 'Vật tư (hộp, túi)', 'Chi phí vận hành (gas, điện)', 'Chi phí khác']
};

// --- Firebase Initialization ---
(function initFirebaseCompat() {
    try {
        const firebaseConfig = {
            apiKey: "AIzaSyBkgzeseW1hFbiEiHrK6kXtMgdFE4gdUSI",
            authDomain: "sothuchiapp-5efc7.firebaseapp.com",
            projectId: "sothuchiapp-5efc7",
            storageBucket: "sothuchiapp-5efc7.appspot.com",
            messagingSenderId: "537279498834",
            appId: "1:537279498834:web:b5277e19fc234d11e36d8b"
        };
        if (typeof firebase === 'undefined') {
            loadingOverlay.innerHTML = '<p class="text-red-500 font-semibold text-center p-4">Lỗi: Thư viện Firebase chưa được tải.</p>';
            return;
        }
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const collectionPath = `/artifacts/${firebaseConfig.projectId}/public/data/shared_transactions`;
        auth.signInAnonymously().then(() => {
            transactionsCollection = db.collection(collectionPath);
            listenForTransactions();
        }).catch(err => {
            console.error("Anonymous sign-in failed:", err);
            loadingOverlay.innerHTML = `<p class="text-red-500">Không thể đăng nhập: ${err.message}.</p>`;
        });
    } catch (err) {
        console.error("Firebase init error:", err);
        loadingOverlay.innerHTML = `<p class="text-red-500">Lỗi khởi tạo Firebase: ${err.message}</p>`;
    }
})();

function listenForTransactions() {
    if (!transactionsCollection) return;
    transactionsCollection.orderBy("date", "desc").onSnapshot(snapshot => {
        transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderAll();
        loadingOverlay.style.display = 'none';
        addTransactionBtnDesktop.disabled = false;
        addTransactionBtnMobile.disabled = false;
    }, err => {
        console.error("Error listening for transactions:", err);
        loadingOverlay.innerHTML = `<p class="text-red-500">Không thể tải dữ liệu: ${err.message}</p>`;
    });
}

// --- Helpers & UI Functions ---
const formatCurrency = (number) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(number || 0);

const updateCategoryOptions = () => {
    const selected = document.querySelector('input[name="type"]:checked').value;
    categorySelect.innerHTML = categories[selected].map(c => `<option value="${c}">${c}</option>`).join('');
    customerInfoDiv.style.display = selected === 'income' ? 'block' : 'none';
};

const renderTransaction = (transaction) => {
    const { id, type, description, amount, date, category, customerName, customerNote } = transaction;
    const isIncome = type === 'income';
    const item = document.createElement('li');
    item.className = `p-4 rounded-lg border-l-4 ${isIncome ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}`;
    const displayDate = date ? new Date(date).toLocaleDateString('vi-VN') : 'Không có ngày';
    let customerHtml = (isIncome && (customerName || customerNote)) 
        ? `<p class="text-sm text-gray-600 mt-1"><strong>KH:</strong> ${customerName || ''} ${customerNote ? `(${customerNote})` : ''}</p>`
        : '';
    item.innerHTML = `
        <div class="flex justify-between items-start">
            <div>
                <p class="font-bold text-gray-500 text-sm">${category || 'Chưa phân loại'}</p>
                <p class="font-semibold text-lg">${description || 'Không có nội dung'}</p>
                <p class="text-xs text-gray-500">${displayDate}</p>
                ${customerHtml}
            </div>
            <div class="text-right flex-shrink-0 ml-4">
                <p class="font-bold text-xl ${isIncome ? 'text-green-600' : 'text-red-600'}">${isIncome ? '+' : '-'}${formatCurrency(amount)}</p>
                <button class="text-xs text-gray-500 hover:text-red-500 transition-colors mt-1" data-id="${id}">Xóa</button>
            </div>
        </div>`;
    item.querySelector('button[data-id]').addEventListener('click', (e) => {
        e.stopPropagation();
        window.deleteTransaction(id);
    });
    return item;
};

const updateSummary = (source) => {
    const totalIncome = source.filter(t => t.type === 'income').reduce((s, t) => s + (t.amount || 0), 0);
    const totalExpense = source.filter(t => t.type === 'expense').reduce((s, t) => s + (t.amount || 0), 0);
    const netProfit = totalIncome - totalExpense;
    totalIncomeEl.textContent = formatCurrency(totalIncome);
    totalExpenseEl.textContent = formatCurrency(totalExpense);
    netProfitEl.textContent = formatCurrency(netProfit);
    netProfitEl.classList.toggle('text-green-600', netProfit >= 0);
    netProfitEl.classList.toggle('text-red-600', netProfit < 0);
    analyzeExpensesBtn.disabled = totalExpense === 0;
    exportXlsxBtn.disabled = source.length === 0;
};

const renderTransactionList = (source) => {
    transactionList.innerHTML = '';
    emptyState.style.display = source.length === 0 ? 'block' : 'none';
    // Data already sorted by Firestore
    source.forEach(transaction => transactionList.appendChild(renderTransaction(transaction)));
};

const filterTransactions = () => {
    const range = reportRangeEl.value;
    if (range === 'all') return transactions.slice();
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    let start, end = new Date();
    end.setHours(23, 59, 59, 999);

    switch(range) {
        case 'day': start = new Date(today); break;
        case 'week': start = new Date(today.setDate(today.getDate() - (today.getDay() || 7) + 1)); break;
        case 'month': start = new Date(today.getFullYear(), today.getMonth(), 1); break;
        case 'quarter': start = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1); break;
        case 'year': start = new Date(today.getFullYear(), 0, 1); break;
        case 'custom':
            start = customStartEl.value ? new Date(customStartEl.value) : null;
            end = customEndEl.value ? new Date(customEndEl.value) : null;
            if(start) start.setHours(0,0,0,0);
            if(end) end.setHours(23, 59, 59, 999);
            break;
        default: start = end = null;
    }

    return transactions.filter(t => {
        if (!t.date) return false;
        const d = new Date(t.date);
        return (!start || d >= start) && (!end || d <= end);
    });
};

const updateCharts = (source) => {
    if (expensePieChart) expensePieChart.destroy();
    if (flowLineChart) flowLineChart.destroy();

    const expenses = source.filter(t => t.type === 'expense');
    if (expenses.length > 0 && expensePieChartCtx) {
        const expenseByCategory = expenses.reduce((acc, curr) => {
            acc[curr.category] = (acc[curr.category] || 0) + (curr.amount || 0);
            return acc;
        }, {});
        expensePieChart = new Chart(expensePieChartCtx, {
            type: 'doughnut',
            data: { labels: Object.keys(expenseByCategory), datasets: [{ data: Object.values(expenseByCategory) }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
};

const addTransaction = async (e) => {
    e.preventDefault();
    const description = descriptionInput.value.trim();
    const amount = amountInput.value.trim();
    if (!description || !amount || +amount <= 0) {
        alert("Vui lòng nhập nội dung và số tiền hợp lệ.");
        return;
    }
    const newTransaction = {
        type: document.querySelector('input[name="type"]:checked').value,
        description: description,
        amount: +amount,
        date: dateInput.value,
        category: categorySelect.value,
        customerName: customerNameInput.value,
        customerNote: customerNoteInput.value
    };
    try {
        await transactionsCollection.add(newTransaction);
        closeTransactionModal();
    } catch (err) {
        alert("Lỗi: Không thể lưu giao dịch. " + err.message);
    }
};

window.deleteTransaction = async (id) => {
    if (!confirm("Bạn có chắc chắn muốn xóa giao dịch này?")) return;
    try {
        await transactionsCollection.doc(id).delete();
    } catch (err) {
        alert("Lỗi: Không thể xóa giao dịch. " + err.message);
    }
};

const exportToXLSX = () => { /* Logic remains unchanged */ };
const openTransactionModal = ()=>{ form.reset(); dateInput.valueAsDate = new Date(); updateCategoryOptions(); transactionModal.classList.remove('hidden'); setTimeout(()=>transactionModal.classList.remove('opacity-0'),10); };
const closeTransactionModal = ()=>{ transactionModal.classList.add('opacity-0'); setTimeout(()=>transactionModal.classList.add('hidden'),300); };
const openAnalysisModal = ()=>{ analysisResult.innerHTML=''; spinnerContainer.style.display='flex'; analysisModal.classList.remove('hidden'); setTimeout(()=>analysisModal.classList.remove('opacity-0'),10); handleAnalysis(); };
const closeAnalysisModal = ()=>{ analysisModal.classList.add('opacity-0'); setTimeout(()=>analysisModal.classList.add('hidden'),300); };

// --- Main Render & Switch ---
const renderAll = () => {
    const filtered = filterTransactions();
    updateSummary(filtered);
    renderTransactionList(filtered); 
    if (!contentDashboard.classList.contains('hidden')) {
        updateCharts(filtered);
    }
};

function switchTab(tab) {
    if (tab === 'history') {
        contentHistory.classList.remove('hidden');
        contentDashboard.classList.add('hidden');
        tabHistory.classList.add('active');
        tabDashboard.classList.remove('active');
    } else {
        contentHistory.classList.add('hidden');
        contentDashboard.classList.remove('hidden');
        tabHistory.classList.remove('active');
        tabDashboard.classList.add('active');
        renderAll();
    }
}

// --- Event Listeners Setup ---
const handleFilterChange = () => {
    const isCustom = reportRangeEl.value === 'custom';
    customDateRangeDiv.classList.toggle('hidden', !isCustom);
    customDateRangeDiv.classList.toggle('flex', isCustom);
    renderAll();
}

addTransactionBtnDesktop.addEventListener('click', openTransactionModal);
addTransactionBtnMobile.addEventListener('click', openTransactionModal);
cancelBtn.addEventListener('click', closeTransactionModal);
form.addEventListener('submit', addTransaction);
typeRadios.forEach(r=>r.addEventListener('change', updateCategoryOptions));
transactionModal.addEventListener('click', (e)=> e.target===transactionModal && closeTransactionModal());
analyzeExpensesBtn.addEventListener('click', openAnalysisModal);
closeAnalysisBtn.addEventListener('click', closeAnalysisModal);
analysisModal.addEventListener('click', (e)=> e.target===analysisModal && closeAnalysisModal());
exportXlsxBtn.addEventListener('click', exportToXLSX);
tabHistory.addEventListener('click', ()=> switchTab('history'));
tabDashboard.addEventListener('click', ()=> switchTab('dashboard'));
reportRangeEl.addEventListener('change', handleFilterChange);
customStartEl.addEventListener('change', renderAll);
customEndEl.addEventListener('change', renderAll);

async function handleAnalysis() { /* Logic remains unchanged */ }

// --- Initial App Load ---
switchTab('history');
handleFilterChange();

</script>

</body>
</html>
